<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Chapter 9. Epic.Prelude</title><link rel="stylesheet" type="text/css" href="css/layout.css" /><link rel="stylesheet" type="text/css" href="css/screen.css" /><link rel="stylesheet" type="text/css" href="css/shCore.css" /><link rel="stylesheet" type="text/css" href="css/shCoreDefault.css" /><link rel="stylesheet" type="text/css" href="css/shThemeDefault.css" /><link rel="stylesheet" type="text/css" href="css/documentation.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.77.1" /><link rel="home" href="manual.html" title="Dominant Domains" /><link rel="up" href="the_bellis_perennis.html" title="Part II. The bellis perennis" /><link rel="prev" href="the_bellis_perennis.html" title="Part II. The bellis perennis" /><link rel="next" href="epic-core.html" title="Chapter 10. Epic.Core" /><meta charset="utf-8" /><link rel="icon" href="/favicon.ico" /><script src="../script/shCore.js" type="text/javascript"></script><script src="../script/shBrushCSharp.js" type="text/javascript"></script><link rel="alternate" type="application/atom+xml" title="Development log" href="/atom.xml" /><!--[if !IE 7]>
    <style type="text/css">
		#wrap {display:table;height:100%}
	</style>
  <![endif]--><!--[if lt IE 8]>
    <style type="text/css">
        #header {padding-top: 9px}
    </style>
  <![endif]--><!--[if IE 8]>
    <style type="text/css">
		#wrap {width:100%}
	</style>
  <![endif]--><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23846269-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script></head><body><div id="wrap"><div id="header"><a href="https://github.com/bards/Epic.NET"><img style="position: absolute; top: 0; left: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png" alt="Fork me on GitHub" /></a><a class="title" href="/">Epic</a><span>dominant domains</span></div><div id="main"><div id="content"><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="epic-prelude"></a>Chapter 9. Epic.Prelude</h2></div></div></div><div class="toc"><ul><li><a href="/doc/manual.html" class="toc-title">Table of Contents</a></li><li><span class="section"><a href="epic-prelude.html#about_interpreting_values">Interpreting values</a></span></li><li><span class="section"><a href="epic-prelude.html#about_specifying_qualities">Specifying qualities</a></span></li></ul></div><p>The Epic.Prelude can be thought of as a preface for your domain model.
It provides a set of general purpose models distilled from our experience.</p><p>Indeed during some years of domain driven design we faced many different
domains and we discovered some common concepts in them (most of which are
rooted in theorethical math). After some trials and errors we got a flexible
design that is proposed in this module.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>You could object that while one of the core design targets of Epic is to
keep the domain model ignorant of the infrastructure, Epic.Prelude
imposes a dependency from Epic itself. You’re right!
You should carefully consider pro and cons of such dependency.
However, since the Epic.Prelude models are actually usefull we decided to
provide them.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>From a legal point of view, by referencing Epic.Prelude, your
domain model will be subjected to the licencing terms with which you obtained
Epic. In other words, if you obtained Epic under the
<a class="ulink" href="http://www.gnu.org/licenses/agpl-3.0.html" target="_top">Affero GPLv3</a>,
your whole domain must be distributed under the terms of such a license.
Note however that, this is already true for the rest of the application built
with Epic. <a class="ulink" href="mailto:giacomo@tesio.it" target="_top">Contact the authors</a> to obtain
a linking exception if you want to write proprietary code.</p></td></tr></table></div><p>Epic itself depends on Prelude’s models, so you will have to include such a
library into the runtime environment of applications using Epic.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="about_interpreting_values"></a>Interpreting values</h2></div></div></div><p>Many value objects serves two different purposes: to enforce a set of specific
rules and to express such a rule. From the client point of view we can call
these two connected responsibilities <span class="strong"><strong>execution</strong></span> and <span class="strong"><strong>interpretation</strong></span>.</p><p>While this could seem quite abstract, it looks perfectly reasonable when we
looks to that particular value objects that work like mathematical functions.
Specifications, for example, are predicates that can be both executed, to know
whether a candidate satisfy them, or interpreted, translating them into a human
readable sentence or into SQL queries. <sup class="footnoteref">[<a name="id735568" href="#ftn.id735568" class="footnote" id="id735568">10</a>]</sup></p><p>The need for value objects' interpretation poses a problem to software
maintenance: how can we stick to the open-closed principle if we have to
interpret an ever growing number of value objects' types?</p><p>Most of interpretation techniques rely on the Visitor design pattern
and its underlying mechanism known as "double dispatch".
However both the <a class="ulink" href="http://en.wikipedia.org/wiki/Visitor_pattern" target="_top">classical</a> and
the <a class="ulink" href="http://objectmentor.com/resources/articles/visitor.pdf" target="_top">acyclic</a> version of
the visitor patterns suffers of a
<a class="ulink" href="http://c2.com/cgi/wiki?VisitorPattern" target="_top">well known limitation</a>: whenever you
want to add a new element to the visited class hierarchy you have to
change all the visitors.</p><p>To address this issue we developed the <span class="strong"><strong>composite visitor</strong></span> pattern that
actually is just an acyclic visitor that replaces inheritance with composition.</p><p>The base interface for visitable objects is the
<a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_IVisitable.htm" target="_top">IVisitable</a> interface
that defines the <a class="ulink" href="http://epic.tesio.it/doc/api/html/M_Epic_IVisitable_Accept__1.htm" target="_top">Accept</a>
method. <sup class="footnoteref">[<a name="id735622" href="#ftn.id735622" class="footnote" id="id735622">11</a>]</sup></p><p>The first difference from the classical pattern is that Accept takes a
<a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_IVisitor_1.htm" target="_top">visitor</a> and a
<a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_IVisitContext.htm" target="_top">context for the visit</a>
decoupling the visitor from its mutable state. <sup class="footnoteref">[<a name="id735646" href="#ftn.id735646" class="footnote" id="id735646">12</a>]</sup></p><p>Moreover, the visitor take controls over it’s own cast to the specialized
visitor type <sup class="footnoteref">[<a name="id735653" href="#ftn.id735653" class="footnote" id="id735653">13</a>]</sup> through
the method <a class="ulink" href="http://epic.tesio.it/doc/api/html/M_Epic_IVisitor_1_AsVisitor__1.htm" target="_top">AsVisitor&lt;TExpression&gt;(TExpression)</a>.</p><p>Thus, when the visitor is an instance of a class that extends the
<a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_CompositeVisitorBase_2.htm" target="_top">CompositeVisitorBase&lt;TResult, TExpression&gt;</a>
abstract class, the composition will be able to returns a specialized visitor
that designed to interpret that specific expression.</p><p>Lets see an example. Whenever the domain model can’t fulfill the user’s requests
the UI have to explain them what happens. So you have correctly modeled a
hundred types of exceptions that the domain objects throw whenever they
need to.
However your users works all over the world, talking different languages.</p><p>In our sample domain for cargo tracking, all the messages from the domain’s
exceptions are already expressive in English. So, for english people
we can just print the message, right? So we write a very simple composable
visitor that returns the exception message and a composition that use it:</p><script type="syntaxhighlighter" class="brush: csharp">public sealed class ReturnMessages :
    CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt;
{
    public ReturnMessages(CompositeVisitor&lt;string&gt; composition)
        : base(composition)
    {
    }

    public string Visit(Exception target, IVisitContext context)
    {
        return target.Message;
    }
}

public sealed class EnglishExceptionsFormatter : CompositeVisitorBase&lt;string, Exception&gt;
{
    public EnglishExceptionsFormatter ()
        : base("EnglishExceptionsMessages")
    {
        new ReturnMessages(this);
    }

    protected override IVisitContext InitializeVisitContext (Exception target, IVisitContext context)
    {
        return context;
    }
}</script><p>Quite verbose, to just return a string, isn’t it? Now consider that actually
we have only control over the domain exception messages. We can’t grant that
<span class="strong"><strong>all</strong></span> exceptions' messages are english! And BTW, we should hide to the user
exceptions details from SqlException and the so. But (for the sake of the example)
we cannot modify the already deployed ReturnMessages.</p><p>Thus we write a new visitor that will intercept all the Exception that are not
defined in the domain model assembly, and return a constant message.</p><script type="syntaxhighlighter" class="brush: csharp">public sealed class ReturnMessages : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class ConstantMessage :
    CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt;
{
    private readonly string _msg;
    public ConstantMessage(CompositeVisitor&lt;string&gt; composition, string message)
        : base(composition)
    {
        _msg = message ?? string.Empty;
    }

    protected override IVisitor&lt;string, TExpression&gt; AsVisitor&lt;TExpression&gt; (TExpression target)
    {
        IVisitor&lt;string, TExpression&gt; visitor = base.AsVisitor (target);

        if (    null == visitor
            || !typeof(TExpression).Assembly.Equals(typeof(Challenge00.DDDSample.Cargo.ICargo).Assembly))
            return null;

        return visitor;
    }

    public string Visit(Exception target, IVisitContext context)
    {
        return _msg;
    }
}
public sealed class EnglishExceptionsFormatter : CompositeVisitorBase&lt;string, Exception&gt;
{
    public EnglishExceptionsFormatter ()
        : base("EnglishExceptionsMessages")
    {
        new ReturnMessages(this);
        new ConstantMessage(this, "An unexpected error occurred. Please contact the administrator.");
    }

    protected override IVisitContext InitializeVisitContext (Exception target, IVisitContext context)
    {
        return context;
    }
}</script><p>Overriding <code class="literal">AsVisitor</code> we inform the composition that <code class="literal">ConstantMessage</code>
cannot handle exceptions defined in the same assembly of <code class="literal">Challenge00.DDDSample.Cargo.ICargo</code>.</p><p>But hey, what if a domain exception is catched and wrapped in a different, unknown one as InnerException?
Since the user speaks the same ubiquitous language of the domain model we want to unwrap the domain exceptions.</p><script type="syntaxhighlighter" class="brush: csharp">public sealed class ReturnMessages : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class ConstantMessage : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class InnerDomainExceptionUnwrap :
    CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt;
{
    public InnerDomainExceptionUnwrap(CompositeVisitor&lt;string&gt; composition)
        : base(composition)
    {
    }

    protected override IVisitor&lt;string, TExpression&gt; AsVisitor&lt;TExpression&gt; (TExpression target)
    {
        IVisitor&lt;string, TExpression&gt; visitor = base.AsVisitor (target);

        if(null == visitor || typeof(TExpression).Assembly.Equals(typeof(Challenge00.DDDSample.Cargo.ICargo).Assembly))
            return null;

        return visitor;
    }

    public string Visit(Exception target, IVisitContext context)
    {
        if(null == target.InnerException)
        {
            return ContinueVisit(target, context);
        }
        else
        {
            return VisitInner(target.InnerException, context);
        }
    }
}
public sealed class EnglishExceptionsFormatter : CompositeVisitorBase&lt;string, Exception&gt;
{
    public EnglishExceptionsFormatter ()
        : base("EnglishExceptionsMessages")
    {
        new ReturnMessages(this);
        new ConstantMessage(this, "An unexpected error occurred. Please contact the administrator.");
        new InnerDomainExceptionUnwrap(this);
    }

    protected override IVisitContext InitializeVisitContext (Exception target, IVisitContext context)
    {
        return context;
    }
}</script><p>However our english messages are still a bit weird. The <code class="literal">Challenge00.DDDSample.Location.WrongLocationException</code>
extends <code class="literal">System.ArgumentException</code> and thus adds to the message provided by the thrower
the parameter name. We could fix this with a custom visitor like we did till now,
but this time we can write a little more general visitor
for the english composition: a <code class="literal">Format&lt;TException&gt;</code>. <sup class="footnoteref">[<a name="id735754" href="#ftn.id735754" class="footnote" id="id735754">14</a>]</sup></p><script type="syntaxhighlighter" class="brush: csharp">public sealed class ReturnMessages : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class ConstantMessage : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class InnerDomainExceptionUnwrap : CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, Exception&gt; {...}
public sealed class Format&lt;TException&gt; :
        CompositeVisitor&lt;string&gt;.VisitorBase, IVisitor&lt;string, TException&gt;
    where TException : Exception
{
    private readonly Func&lt;TException, string&gt; _format;
    private readonly Func&lt;TException, bool&gt; _acceptanceRule;
    public Format(CompositeVisitor&lt;string&gt; composition, Func&lt;TException, string&gt; format)
        : this(composition, format, e =&gt; true)
    {
    }

    public Format(CompositeVisitor&lt;string&gt; composition,
                  Func&lt;TException, string&gt; format,
                  Func&lt;TException, bool&gt; acceptanceRule)
        : base(composition)
    {
        if (null == format)
            throw new ArgumentNullException("format");
        if (null == acceptanceRule)
            throw new ArgumentNullException("acceptanceRule");
        _format = format;
        _acceptanceRule = acceptanceRule;
    }

    protected override IVisitor&lt;string, TExpression&gt; AsVisitor&lt;TExpression&gt;(TExpression target)
    {
        IVisitor&lt;string, TExpression&gt; visitor = base.AsVisitor(target);

        if (null == visitor || !_acceptanceRule(target as TException))
            return null;

        return visitor;
    }

    #region IVisitor implementation
    public string Visit(TException target, IVisitContext context)
    {
        return _format(target);
    }
    #endregion
}
public sealed class EnglishExceptionsFormatter : CompositeVisitorBase&lt;string, Exception&gt;
{
    public EnglishExceptionsFormatter ()
        : base("EnglishExceptionsMessages")
    {
        new ReturnMessages(this);
        new ConstantMessage(this, "An unexpected error occurred. Please contact the administrator.");
        new InnerDomainExceptionUnwrap(this);
        new Format&lt;Challenge00.DDDSample.Location.WrongLocationException&gt;(this,
            e =&gt; e.Message.Substring(0, e.Message.LastIndexOf("\r\n")));
    }

    protected override IVisitContext InitializeVisitContext (Exception target, IVisitContext context)
    {
        return context;
    }
}</script><p>As you can see, we changed the composition behaviour without any violation to
the open-closed principle, by simply adding new visitors to the composition.</p><p>To run the visit we simply have to write:</p><script type="syntaxhighlighter" class="brush: csharp">try
{
    // some code here
}
catch(Exception e)
{
    // TODO add log here :-)
    IVisitor&lt;string&gt; formatter = new EnglishExceptionsFormatter();
    string exceptionMessage = e.Accept(formatter, VisitContext.New);
    NotifyFailureToUser(exceptionMessage);
}</script><p>But what about the other languages? Let’s try with italian:</p><script type="syntaxhighlighter" class="brush: csharp">public sealed class ItalianExceptionsFormatter : CompositeVisitorBase&lt;string, Exception&gt;
{
    public ItalianExceptionsFormatter()
        : base("ItalianExceptionsFormatter")
    {
        new ConstantMessage(this, "Si è verificato un errore imprevisto. Contattare l'amministratore del sistema.");
        new InnerDomainExceptionUnwrap(this);
        new Format&lt;Challenge00.DDDSample.Location.WrongLocationException&gt;(this,
            e =&gt; string.Format("Non è possibile effettuare l'operazione, perché la località fornita ({0}) non coincide con quella prevista ({1}).", e.ActualLocation, e.ExpectedLocation));
        new Format&lt;Challenge00.DDDSample.Voyage.VoyageCompletedException&gt;(this,
            e =&gt; string.Format("Il viaggio '{0}' ha già raggiunto la propria destinazione.", e.Voyage));
        new Format&lt;Challenge00.DDDSample.Cargo.AlreadyClaimedException&gt;(this,
            e =&gt; string.Format("Non è possibile effettuare l'operazione perché il cargo '{0}' è già stato ritirato.", e.Cargo));
        new Format&lt;Challenge00.DDDSample.Cargo.RoutingException&gt;(this,
            e =&gt; string.Format("Non è possibile effettuare l'operazione perché il cargo '{0}' è stato diretto su un percorso sbagliato.", e.Cargo),
            e =&gt; e.RoutingStatus == Challenge00.DDDSample.Cargo.RoutingStatus.Misrouted);
        new Format&lt;Challenge00.DDDSample.Cargo.RoutingException&gt;(this,
            e =&gt; string.Format("Non è possibile effettuare l'operazione perché non è ancora stato assegnato un percorso al cargo '{0}'.", e.Cargo),
            e =&gt; e.RoutingStatus == Challenge00.DDDSample.Cargo.RoutingStatus.NotRouted);
        new Format&lt;Challenge00.DDDSample.Cargo.RoutingException&gt;(this,
            e =&gt; "Si è verificato un errore imprevisto. Contattare l'amministratore del sistema.",
            e =&gt; e.RoutingStatus == Challenge00.DDDSample.Cargo.RoutingStatus.Routed);
    }

    protected override IVisitContext InitializeVisitContext (Exception target, IVisitContext context)
    {
        return context;
    }
}</script><p>While the example is quite straightforward, you’ve got the point. You can
enhance the behaviour of a visitor’s composition by simply initializing a new visitor.</p><p>This turned to be a really powerfull tool, able to visit complex expression
trees and translate them to nice, human readable, messages or to SQL queries.
Moreover, when the class hierachy grows, you don’t need to break existing
visitors: you can always extend the behaviour of the composition by adding
code, keeping the DLLs already deployed untouched.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="about_specifying_qualities"></a>Specifying qualities</h2></div></div></div><p>Coming soon.</p></div><div class="footnotes"><br /><hr style="width:100; align:left;" /><div id="ftn.id735568" class="footnote"><p><sup class="footnote">[<a name="ftn.id735568" href="#id735568" class="simpara" id="ftn.id735568">10</a>] </sup>A closer look shows that execution
is actually a specific kind of interpretation, done by the CLR. Indeed, some stacktraces
from <a class="ulink" href="http://msdn.microsoft.com/en-us/library/bb345362" target="_top">Expression&lt;TDelegate&gt;.Compile</a>
show that expression tree compilation is done by a visitor producing the executable IL code.</p></div><div id="ftn.id735622" class="footnote"><p><sup class="footnote">[<a name="ftn.id735622" href="#id735622" class="simpara" id="ftn.id735622">11</a>] </sup>To reduce the effort of implementing the IVisitable interface,
a <a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_VisitableBase.htm" target="_top">base class</a> exists.
Moreover, a set of extension methods is provided for well known class hierarchy
such as Exceptions, EventArgs and Expressions.</p></div><div id="ftn.id735646" class="footnote"><p><sup class="footnote">[<a name="ftn.id735646" href="#id735646" class="simpara" id="ftn.id735646">12</a>] </sup>We want the visitors to
be stateless so that we can initialize each of them only once, at application
start up, and then use the computation they express in parallel from different
threads.</p></div><div id="ftn.id735653" class="footnote"><p><sup class="footnote">[<a name="ftn.id735653" href="#id735653" class="simpara" id="ftn.id735653">13</a>] </sup>We called this technique "managed cast". It consists
into delegating a cast to the object that you want to cast, so that it has
control on the casting behaviour according to runtime conditions.</p></div><div id="ftn.id735754" class="footnote"><p><sup class="footnote">[<a name="ftn.id735754" href="#id735754" class="simpara" id="ftn.id735754">14</a>] </sup>Being such a use case
so frequent, Epic provides an even more general version of this class: the
<a class="ulink" href="http://epic.tesio.it/doc/api/html/T_Epic_Visitors_SimpleFormatter_1.htm" target="_top">SimpleFormatter&lt;TTarget&gt;</a>. </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="the_bellis_perennis.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="the_bellis_perennis.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="epic-core.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part II. The bellis perennis </td><td width="20%" align="center"><a accesskey="h" href="manual.html">Table of Contents</a></td><td width="40%" align="right" valign="top"> Chapter 10. Epic.Core</td></tr></table></div></div></div></div><div id="footer"><div class="copyright">Copyright © 2010-2012 Giacomo Tesio</div></div><script type="text/javascript">SyntaxHighlighter.all()</script></body></html>
